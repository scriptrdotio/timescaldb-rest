var http = require("http");
var log = require("log"); log.setLevel("info");

/**
 * A generic http client that handles the communication with remote APIs
 * @class Client
 * @constructor Client
 * @param {Object} credentials: object contains db url, username, password and authEnabled
 * @throw {Error}
 */
function Client(credentials) {
    log.info("credentials: " + JSON.stringify(credentials));
    if (!credentials || !credentials.url) {
        throw {
            errorCode: "Missing_Parameter",
            errorDetail: "Client: credentials.url must be provided"
        };
    }

    this.url = credentials.url;
    this.authEnabled = credentials.authEnabled;
    this.username = credentials.username;
    this.password = credentials.password;
    this.headers = { 'Content-Type': 'application/x-www-form-urlencoded'};

    if(this.authEnabled){
        this.headers["Authorization"] = "Basic " + btoa(this.username + ":" + this.password);
    }
}

/**
 * Invoke a given API.
 * This method can throw exceptions
 * @method callApi
 * @param {Object} params : the parameters of the http call to issue
 *	{String} params.queryString : (optional) the http queryString to use when invoking 
 *	{String} params.bodyString : (optional) the http bodyString to use when invoking 
 *	{String} params.method : (optional) the http method to use when invoking 
 *	{Object} params.params: (optional) the parameters that are expected by the API
 */
Client.prototype.callApi = function(params) {
    try {   
        var paramsClone = JSON.parse(JSON.stringify(params));
        return this._callApi(paramsClone);
    }catch(response) {
        this._handleError(response);
    }
};

Client.prototype._callApi = function(params) {
    log.info("params: " + JSON.stringify(params));
    if(!params.api){
        throw {
            errorCode: "Missing_Parameter",
            errorDetail: "Client: params.api"
        };
    }

    params.url = this.url + params.api;

    if(params.queryString != null && params.queryString != ""){
        if(!params.queryString.startsWith("?"))
            params.url += "?";

        params.url += params.queryString;
    }

    if(params.headers){
        log.info("params.headers exist");
        if(this.headers){
            log.info("appending this.headers to params.headers");
            log.info("this.headers: " + JSON.stringify(this.headers));
            var keys = Object.keys(this.headers);
            for(var i = 0; i < keys.length; i++){
                params.headers[keys[i]] = this.headers[keys[i]];
            }
            log.info("params.headers after append: " + JSON.stringify(params.headers));
        }
    }else
    	params.headers = this.headers ? this.headers : {};
    
    log.info("Sending the following request: " + JSON.stringify(params));
    var response = http.request(params);

    log.info("Received following response: " + JSON.stringify(response));
    log.info("response headers: " + JSON.stringify(response.headers));
    if (response.status == "200" || response.status == "201" || response.status == "206" || response.status == "204") {
        var finalResponse = {};
        var responseBody = response.body;
        var responseHeaders = response.headers;
        
        if (responseBody) {
            try { 
                responseBody = JSON.parse(responseBody ?  responseBody : {});
            }catch(exception) {
                responseBody = responseBody;
            } 
            
            if (responseBody.error || responseBody.errorCode) {
                throw response;
            }
            finalResponse.body = responseBody;
        }   

        if (responseHeaders) {
            finalResponse.headers = responseHeaders;
        }  

        return finalResponse;
    }else {
        throw response;
    }
};

Client.prototype._handleError = function(response) {
    var errorObj = "";
    try {

        errorObj = JSON.parse(response.body);
    }catch(e) {

        try {
            errorObj = JSON.parse(response);
        }catch(e) {
            errorObj = response;
        }
    };

    if(errorObj != null && errorObj.metadata != null 
       && errorObj.metadata.errorCode != null && errorObj.metadata.errorCode != "" ){
        throw {
            "errorCode": errorObj.metadata.errorCode,
            "errorDetail": (errorObj.metadata.errorDetail != null && errorObj.metadata.errorDetail != "") ? errorObj.metadata.errorDetail : ""
        };

    }else{
        throw {
            "errorCode": "Invocation_Error",
            "errorDetail": typeof(errorObj) == "object" ? JSON.stringify(errorObj) : errorObj
        };
    }

};
